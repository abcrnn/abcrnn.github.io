<!DOCTYPE html>
<html>

<head>
    <title>abcRNN</title>
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/materialize.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="css/abcjs-midi.css" media="all" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/0.13.5/tf.min.js"></script>
    <script src="/js/abcjs_midi_5.6.5-min.js" type="text/javascript"></script>
    <style>
        textarea {
            width: unset;
            height: unset;
        }
        @media print {
            h1, p, textarea, #selection, #midi, #midi-download, hr {
                display: none;
            }
            .paper {
                position: absolute;
            }
        }
    </style>
</head>

<body class="blue-grey lighten-5">
    <nav class="teal">
        <div class="nav-wrapper container">
            <a href="#" data-activates="slide-out" class="button-collapse"><i class="icon ion-navicon"></i></a>
            <a href="index.html" class="brand-logo">
                <i class="icon left ion-headphone hide-on-small-only"></i> abcRNN - Music Generator
            </a>
            <ul class="right hide-on-med-and-down">
                <li>
                    <a href="https://github.com/abcrnn/abcrnn.github.io" class="waves-effect waves-light" target="_blank"><i class="icon ion-social-github left"></i>Github</a>
                </li>
                <li><a href="#" class="waves-effect">Home</a></li>
                <li><a href="/model-eval">Model Evaluation</a></li>
            </ul>
            <ul id="slide-out" class="side-nav">
                <li><a href="https://github.com/abcrnn/abcrnn.github.io"><i class="icon ion-social-github"></i>Github</a></li>
                <li><a href="#" class="waves-effect">Home</a></li>
                <li><a href="/model-eval">Model Evaluation</a></li>
            </ul>
        </div>
    </nav>
    <section id="banner" class="center container">
        <h1>Welcome to abcRNN</h1>
        <p class="flow-text">Web app demo coming soon!</p>
        <button id="musicButton" class="purple btn-large waves-effect animated pulse infinite" onClick="init()">Let's Generate Music! Click Me!</button>
        <div class="abcjs">
            <textarea name="abc" id="abc" cols="80" rows="15">X: 1
T: Cooley's
M: 4/4
L: 1/8
R: reel
K: Emin
|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|
eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|
            </textarea>
            <hr />
            <div id="midi"></div>
            <div id="midi-download"></div>
            <div id="warnings"></div>
            <div id="paper0" class="paper"></div>
            <div id="paper1" class="paper"></div>
            <div id="paper2" class="paper"></div>
            <div id="paper3" class="paper"></div>
            <div id="selection"></div>
        </div>
    </section>
    <section class="row center-align container">
        <br><br>
        <h4>About</h4>
        <div class="col s12 m6 l4">
            <i class="icon ion-ios-list-outline x5"></i>
            <h5>Problem</h5>
            <p>New ideas are hard to come by. Musicians occasionally have hard to generating new music. Most musicians need inspiration before composing their own music.</p>
        </div>
        <div class="col s12 m6 l4">
        </div>
        <div class="col s12 m6 l4">
            <i class="icon ion-ios-list-outline x5"></i>
            <h5>Goal</h5>
            <p>The goal of this app is to help artists to create new music on a specific genre.</p>
        </div>
    </section>

    <footer class="page-footer teal darken-4">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Project Description</h5>
                    <p class="grey-text text-lighten-4">Create an powerful music generation model that can be used to help artists</p>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2019 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">Powered by abcRNN</a>
            </div>
        </div>
    </footer>
    <script src="js/jquery.min.js"></script>
    <script src="js/materialize.min.js"></script>
    <script src="js/app.js"></script>
    <script type="text/javascript">
        async function loadDict() {
            await $.getJSON("test_model/model_dictionary.json", function(json) {
                console.log(json); // this will show the info it in firebug console
                obj = json;
            });
        }
/*
        async function init() {
            var seq_length = 50;
            var starting = "[A2F,2]dc [B2D2]A2 | [G2E,2]gf";
            console.log('Start loading dicionary')
            await loadDict();
            console.log('Finish loading dicionary')
            console.log('Start loading model') 
            model = await tf.loadModel('test_model/model.json')
            console.log('Finish loading model') 
            var sequence_index = []
            console.log(obj)
            for (var i = 0; i < starting.length; i++) {
                console.log(starting.charAt(i));
                sequence_index.push(obj.char2idx[starting.charAt(i)])
            }
            console.log(sequence_index)
            var seq_len = starting.length
            var n_vocab = Object.keys(obj.idx2char).length;
            var prev = undefined
            for (var i = 0; i < seq_length - seq_len; i++) {
                var batch = sequence_index.slice(Math.max(sequence_index.length - seq_len, 0))
                var predicted_probs = model.predictOnBatch(tf.tensor([batch]))

                predicted_probs.print()
                predicted_probs = tf.slice(predicted_probs, [0, 29, 0], [1, 1, 67])
                predicted_probs.print()
                sample = tf.argMax(predicted_probs.flatten())
                sample.print()
                var char_note = obj.idx2char[sample.get()]
                console.log(char_note)
                if (char_note === '\n' && char_note === prev) {
                    continue;
                } 
                sequence_index.push(sample)
                prev = char_note
            }

            console.log(sequence_index)
            console.log(sequence_index.length)
            //tf.slice(predicted_probs, [0, 29, 0], [1, 1, 67]).print()
        }
        */

        async function init() {
            var seq_length = 300;
            var starting = "[A2F,2]dc [B2D2]A2 | [G2E,2]gf";
            console.log('Start loading dicionary')
            await loadDict();
            console.log('Finish loading dicionary')
            console.log('Start loading model') 
            model = await tf.loadModel('test_model/model.json')
            console.log('Finish loading model') 
            var sequence_index = []
            console.log(obj)
            for (var i = 0; i < starting.length; i++) {
                console.log(starting.charAt(i));
                sequence_index.push(obj.char2idx[starting.charAt(i)])
            }
            console.log(sequence_index)
            var seq_len = starting.length
            var n_vocab = Object.keys(obj.idx2char).length;
            var prev = undefined
            for (var i = 0; i < seq_length - seq_len; i++) {
                var batch = sequence_index.slice(Math.max(sequence_index.length - seq_len, 0))
                var predicted_probs = model.predictOnBatch(tf.tensor([batch]))

                predicted_probs.print()
                predicted_probs = tf.slice(predicted_probs, [0, 29, 0], [1, 1, 67])
                predicted_probs.print()
                sample = tf.argMax(predicted_probs.flatten())
                sample.print()
                var char_note = obj.idx2char[sample.get()]
                console.log(char_note)
                if (char_note === '\n' && char_note === prev) {
                    continue;
                } 
                sequence_index.push(sample.get())
                prev = char_note
            }
            var str_seq = "";
            for (var i = 0; i < sequence_index.length; i++) {
                str_seq += obj.idx2char[sequence_index[i]];
            }           
            console.log(sequence_index)
            console.log(sequence_index.length)
            console.log(str_seq)
            $('#musicButton').css('display', 'none');
            document.getElementById("abc").value = str_seq;
            initEditor();
            $('.abcjs').css('display', 'block');
            //tf.slice(predicted_probs, [0, 29, 0], [1, 1, 67]).print()
        }
        
        function selectionCallback(abcelem) {
            var note = {};
            for (var key in abcelem) {
                if (abcelem.hasOwnProperty(key) && key !== "abselem")
                    note[key] = abcelem[key];
            }
            console.log(abcelem);
            var el = document.getElementById("selection");
            el.innerHTML = "<b>selectionCallback parameter:</b><br>" + JSON.stringify(note);
        }

        function initEditor() {
            new ABCJS.Editor("abc", { paper_id: "paper0",
                generate_midi: true,
                midi_id:"midi",
                midi_download_id: "midi-download",
                generate_warnings: true,
                warnings_id:"warnings",
                abcjsParams: {
                    generateDownload: true,
                    clickListener: selectionCallback
                }
            });
        }

        window.addEventListener("load", initEditor, false);
        var model;
        var obj = undefined;
        window.onload = function() {
            //init(); 
        }
    </script>
</body>

</html>
