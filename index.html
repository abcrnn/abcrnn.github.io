<!DOCTYPE html>
<html>

<head>
    <title>abcRNN</title>
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/materialize.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="css/abcjs-midi.css" media="all" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/0.13.5/tf.min.js"></script>
    <script src="./js/abcjs_midi_5.6.5-min.js" type="text/javascript"></script>
    <script src="./js/chance.min.js" type="text/javascript"></script>
    <style>
        textarea {
            width: unset;
            height: unset;
        }
        @media print {
            h1, p, textarea, #selection, #midi, #midi-download, hr {
                display: none;
            }
            .paper {
                position: absolute;
            }
        }
    </style>
</head>

<body class="blue-grey lighten-5">
    <nav class="teal">
        <div class="nav-wrapper container">
            <a href="#" data-activates="slide-out" class="button-collapse"><i class="icon ion-navicon"></i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="#" class="waves-effect">Home</a></li>
                <li><a href="./about.html" class="waves-effect">About</a></li>
                <li><a href="./model-eval.html">Model Evaluation</a></li>
                <li>
                    <a href="https://github.com/abcrnn/abcrnn.github.io" class="waves-effect waves-light" target="_blank"><i class="icon ion-social-github left"></i>Github</a>
                </li>
            </ul>
            <ul id="slide-out" class="side-nav">
                <li><a href="./index" class="waves-effect">Home</a></li>
                <li><a href="./about" class="waves-effect">About</a></li>
                <li><a href="./model-eval">Model Evaluation</a></li>
                <li>
                    <a href="https://github.com/abcrnn/abcrnn.github.io" class="waves-effect waves-light" target="_blank"><i class="icon ion-social-github left"></i>Github</a>
                </li>
            </ul>
        </div>
    </nav>
    <section id="banner" class="center container">
        <img src="img/abcRnn_logo.png" class="center-img"/>
        <p class="flow-text">Disclaimer: It might take a while for the music to generate. Please be patient! </p>
        <p id = "status"></p>
        <button id="musicButton" class="purple btn-large waves-effect animated pulse infinite" style="display: none">Let's Generate Music! Click Me!</button>
        <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
        <div class="abcjs">
            <textarea name="abc" id="abc" cols="80" rows="15">X: 1
T: Cooley's
M: 4/4
L: 1/8
R: reel
K: Emin
|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|
EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|
|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|
eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|
            </textarea>
            <hr />
            <div id="midi"></div>
            <div id="midi-download"></div>
            <div id="warnings"></div>
            <div id="paper0" class="paper"></div>
            <div id="paper1" class="paper"></div>
            <div id="paper2" class="paper"></div>
            <div id="paper3" class="paper"></div>
            <div id="selection"></div>
        </div>
    </section>
    <section class="row center-align container">
        <br><br>
        <h4>About</h4>
        <div class="col s12 m6 l4">
            <i class="icon ion-ios-list-outline x5"></i>
            <h5>Problem</h5>
            <p>New ideas are hard to come by. Musicians occasionally have hard to generating new music. Most musicians need inspiration before composing their own music.</p>
        </div>
        <div class="col s12 m6 l4">
        </div>
        <div class="col s12 m6 l4">
            <i class="icon ion-ios-list-outline x5"></i>
            <h5>Goal</h5>
            <p>The goal of this app is to help artists to create new music on a specific genre.</p>
        </div>
    </section>

    <footer class="page-footer teal">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Project Description</h5>
                    <p class="grey-text text-lighten-4">Create an powerful music generation model that can be used to help artists</p>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Â© 2019 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">Powered by abcRNN</a>
            </div>
        </div>
    </footer>
    <script src="js/jquery.min.js"></script>
    <script src="js/materialize.min.js"></script>
    <script src="js/app.js"></script>
    <script type="text/javascript">
        async function loadDict() {
            await $.getJSON("https://abcrnn.github.io/music_generation.python/music_model/classical_music_model/model_dictionary.json", function(json) {
                console.log(json); // this will show the info it in firebug console
                obj = json;
            });
        }

        async function init() {
            document.getElementById('status').innerHTML = 'Loading model ...'
            console.log('Start loading model') 
            model = await tf.loadModel('https://abcrnn.github.io/music_generation.python/music_model/classical_music_model/model.json')
            console.log('Finish loading model') 
            document.getElementById('status').innerHTML = 'Model loaded!'
            $('#musicButton').css('display', 'inline-block');
        }
        
        $('#musicButton').on('click', async function(){
            $('#musicButton').css('display', 'none');
            $('.lds-ring').css('display', 'inline-block');
            console.log('Start loading dictionary')
            await loadDict();
            console.log('Finish loading dictionary')
            generate(200, 'argmax');//does not use argmax
        });

        /**
         * Python np.range equivalent when step=1 
         */
        function range(range_val){
            return Array(range_val).fill(1).map((x, y) => x + y)
        }

        /**
         * Python np.random.choice with weight probability equivalent
         */
        function randomChoice(range_vals, pred_prob_arr){
            var chosen = chance.weighted(range_vals, pred_prob_arr);
            return chosen;
        }

        /**
         * sampling_type: 'argmax', 'multinomial'
         */
        function generate(seq_length, sampling_type) {
            //var starting = "[A2F,2]dc [B2D2]A2 | [G2E,2]gf";
            //var starting = "[B,4d4] [c4A,4F,4] d4 | [dA,]^"
            var starting = "[d3F,3]G,3E,3 [d3F,3]D,3 |E,3 "
            var sequence_index = []
            console.log(obj)
            for (var i = 0; i < starting.length; i++) {
                // console.log(starting.charAt(i));
                sequence_index.push(obj.char2idx[starting.charAt(i)])
            }
            console.log(sequence_index)
            var seq_len = starting.length
            var n_vocab = Object.keys(obj.idx2char).length;
            var prev = undefined;
            var sample; 
            for (var i = 0; i < seq_length - seq_len; i++) {
                var batch = sequence_index.slice(Math.max(sequence_index.length - seq_len, 0))
                var predicted_probs = model.predictOnBatch(tf.tensor([batch]))

                predicted_probs = tf.slice(predicted_probs, [0, 29, 0], [1, 1, n_vocab])
                if (sampling_type == 'argmax') sample = tf.argMax(predicted_probs.flatten()).get();
                else if (sampling_type == 'multinomial'){
                    var pred_probs_arr = Array.from(predicted_probs.dataSync());
                    sample = randomChoice(range(n_vocab), pred_probs_arr);
                }



                var char_note = obj.idx2char[sample]


                if (char_note === '\n' && char_note === prev) {
                    continue;
                } 
                sequence_index.push(sample)
                prev = char_note
            }
            var str_seq = "";
            var starting_seq = (function () {/*
T: abcRNN generated sequence
M: 4/4
K: Cmin
*/}).toString().match(/[^]*\/\*([^]*)\*\/\}$/)[1]; //python equivalent on ''' ''' block string

            str_seq = starting_seq;

            for (var i = 0; i < sequence_index.length; i++) {
                str_seq += obj.idx2char[sequence_index[i]];
            }           
            console.log(sequence_index)
            console.log(sequence_index.length)
            console.log(str_seq)
            $('.flow-text').css('display', 'none');
            $('.lds-ring').css('display', 'none');
            document.getElementById("abc").value = str_seq;
            initEditor();
            $('.abcjs').css('display', 'block');
        }

        function selectionCallback(abcelem) {
            var note = {};
            for (var key in abcelem) {
                if (abcelem.hasOwnProperty(key) && key !== "abselem")
                    note[key] = abcelem[key];
            }
            console.log(abcelem);
            var el = document.getElementById("selection");
            el.innerHTML = "<b>selectionCallback parameter:</b><br>" + JSON.stringify(note);
        }

        function initEditor() {
            new ABCJS.Editor("abc", { paper_id: "paper0",
                generate_midi: true,
                midi_id:"midi",
                midi_download_id: "midi-download",
                generate_warnings: true,
                warnings_id:"warnings",
                abcjsParams: {
                    generateDownload: true,
                    //clickListener: selectionCallback
                }
            });
        }

        window.addEventListener("load", initEditor, false);
        var model;
        var obj = undefined;
        window.onload = function() {
            init(); 

        }
    </script>
</body>

</html>
